# Система логирования

Проект использует продвинутую систему логирования с автоматической ротацией файлов по датам и уведомлениями администраторов в Telegram.

## Особенности

- **Ротация по датам**: Каждый день создается новый файл лога в формате `bot-YYYY-MM-DD.log`
- **Автоматическая очистка**: Старые логи удаляются автоматически (по умолчанию старше 30 дней)
- **Гибкая настройка**: Уровни логирования, директории, форматы настраиваются
- **Консольный и файловый вывод**: Логи выводятся в консоль и сохраняются в файлы
- **Уведомления админов**: Автоматическая отправка важных событий в Telegram
- **Контекст апдейтов**: В логах сохраняется информация о пользователе и типе события
- **Утилита просмотра**: Встроенная утилита для просмотра и управления логами

## Структура файлов

```
logs/
├── .gitkeep                    # Сохраняет папку в git
├── bot-2025-10-10.log         # Лог за конкретную дату
├── bot-2025-10-11.log         # Лог за следующую дату
└── ...

app/infrastructure/
└── logging.py                  # Модуль настройки логирования

tools/
└── log_viewer.py              # Утилита просмотра логов
```

## Использование

### Запуск бота
```bash
python3 main.py
```

Логи автоматически сохраняются в папку `logs/` с именем `bot-YYYY-MM-DD.log`

### Просмотр логов

#### Список всех файлов логов:
```bash
python3 tools/log_viewer.py list
```

#### Просмотр последних строк лога:
```bash
python3 tools/log_viewer.py show bot-2025-10-10.log --lines 50
```

#### Следование за логом в реальном времени (как tail -f):
```bash
python3 tools/log_viewer.py show bot-2025-10-10.log --follow
```

#### Очистка старых логов:
```bash
python3 tools/log_viewer.py clean --keep-days 30
```

### Программное использование

```python
from app.infrastructure.logging import setup_logging
import logging

# Настройка логирования
setup_logging(
    log_level="INFO",
    log_dir="logs", 
    console_output=True,
    file_prefix="bot"
)

# Использование
logging.info("Информационное сообщение")
logging.warning("Предупреждение") 
logging.error("Ошибка")
```

## Конфигурация

Все настройки логирования задаются через переменные окружения в файле `.env`:

```env
# Уровень логирования: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO

# Директория для сохранения логов
LOG_DIR=logs

# Выводить логи в консоль (true/false)
CONSOLE_OUTPUT=true

# Префикс для имен файлов логов
LOG_FILE_PREFIX=bot

# Количество дней хранения логов
LOG_RETENTION_DAYS=30

# ID администраторов для уведомлений (через запятую)
ADMIN_IDS=123456789,987654321
```

## Уведомления администраторов

Система автоматически отправляет уведомления в Telegram:

- **ERROR и CRITICAL**: Отправляются немедленно
- **WARNING**: Отправляются при превышении 5 предупреждений за минуту
- **Контекст**: Каждое уведомление содержит информацию о пользователе, чате и типе события

### Настройка админов

Добавьте ID администраторов в `.env`:
```env
ADMIN_IDS=257026813,123456789
```

Чтобы узнать свой ID, отправьте `/start` боту [@userinfobot](https://t.me/userinfobot).

### Уровни логирования

- **DEBUG**: Максимальная детализация (для отладки)
- **INFO**: Стандартная информация о работе (рекомендуется для продакшена)
- **WARNING**: Только предупреждения и ошибки
- **ERROR**: Только ошибки и критические сообщения
- **CRITICAL**: Только критические ошибки

### Тестирование настроек

Используйте утилиту тестирования:

```bash
# Тестирование текущих настроек из .env
python3 tools/test_logging.py

# Тестирование всех уровней логирования
python3 tools/test_logging.py --all-levels
```

## Уровни логирования

- **DEBUG**: Детальная отладочная информация
- **INFO**: Общая информация о работе бота
- **WARNING**: Предупреждения о потенциальных проблемах
- **ERROR**: Ошибки, которые не останавливают работу
- **CRITICAL**: Критические ошибки, останавливающие работу

## Автоматическая очистка

При запуске бота автоматически удаляются файлы логов старше 30 дней (настраивается).

## Файлы логов

Каждый файл лога содержит:
- Временную метку
- Имя логгера
- Уровень сообщения
- Текст сообщения

Пример записи:
```
2025-10-10 21:20:40 - app.bot.bot - INFO - Bot started successfully!
```

## Мониторинг в production

Для продакшена рекомендуется:

1. **Логротация**: Система уже настроена для ежедневной ротации
2. **Мониторинг размера**: Следить за размером папки logs/
3. **Резервное копирование**: Настроить backup важных логов
4. **Alerting**: Настроить уведомления при критических ошибках

## Интеграция с внешними системами

Логи можно легко интегрировать с:
- **ELK Stack** (Elasticsearch, Logstash, Kibana)
- **Grafana** + **Loki**
- **Prometheus** для метрик
- **Sentry** для отслеживания ошибок

## Troubleshooting

### Логи не создаются
- Проверьте права доступа к папке `logs/`
- Убедитесь что папка `logs/` существует

### Большой размер логов
- Уменьшите `LOG_RETENTION_DAYS`
- Поднимите уровень логирования до WARNING или ERROR

### Проблемы с кодировкой
- Все файлы создаются в UTF-8
- При просмотре используйте поддерживающие UTF-8 редакторы