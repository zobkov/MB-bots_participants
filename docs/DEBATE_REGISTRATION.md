# Система регистрации на дебаты

## Описание

Система позволяет участникам конференции регистрироваться на дебаты по 5 различным кейсам:

1. **ВТБ** - индивидуальный лимит 32 человека
2. **Алабуга** - общий лимит с Б1 (41 человек)
3. **Б1** - общий лимит с Алабугой (41 человек)
4. **Северсталь** - общий лимит с Альфой (42 человека)
5. **Альфа** - общий лимит с Северсталью (42 человека)

## Техническая реализация

### База данных

Используется PostgreSQL с таблицей `users`:
- `id` - telegram user_id (PRIMARY KEY)
- `username` - telegram username
- `visible_name` - отображаемое имя пользователя
- `debate_reg` - номер кейса на который зарегистрирован (1-5, NULL если не зарегистрирован)

### Кеширование

Redis используется для кеширования текущего количества регистраций по каждому кейсу. Это позволяет:
- Быстро отображать актуальное количество свободных мест
- Предотвращать race conditions при регистрации
- Снизить нагрузку на основную базу данных

### Логика регистрации

1. При первом заходе в бота (`/start`) пользователь автоматически добавляется в таблицу `users`
2. В диалоге регистрации отображаются доступные кейсы с количеством свободных мест
3. При выборе кейса проверяется доступность мест (защита от race conditions)
4. Показывается окно подтверждения
5. При подтверждении снова проверяется доступность и выполняется регистрация
6. Данные обновляются в БД и Redis кеше

### Ограничения и лимиты

- **ВТБ**: максимум 32 регистрации
- **Алабуга + Б1**: суммарно максимум 41 регистрация
- **Северсталь + Альфа**: суммарно максимум 42 регистрации

## Управление системой

### Просмотр статистики

```bash
python3 tools/debate_manager.py stats
```

Показывает:
- Текущее количество регистраций по каждому кейсу в БД и Redis
- Количество оставшихся мест
- Предупреждения о несоответствии данных между БД и Redis

### Синхронизация Redis с БД

```bash
python3 tools/debate_manager.py sync
```

Принудительно синхронизирует кеш Redis с данными из базы данных.

### Сброс всех регистраций (для тестирования)

```bash
python3 tools/debate_manager.py reset
```

**⚠️ ВНИМАНИЕ**: Удаляет все регистрации пользователей на дебаты!

### Просмотр пользователей

```bash
# Все пользователи
python3 tools/user_manager.py list

# Только зарегистрированные на дебаты
python3 tools/user_manager.py registered

# Поиск пользователя
python3 tools/user_manager.py search "Имя пользователя"
python3 tools/user_manager.py search 123456789

# Статистика базы данных
python3 tools/user_manager.py stats
```

### Экспорт участников

```bash
python3 tools/export_participants.py
```

Создает CSV файл со всеми участниками и их регистрациями.

## Административные команды бота

Для администраторов доступны следующие команды через бота:

- `/debate_stats` - Быстрая статистика регистрации
- `/detailed_stats` - Детальная статистика с именами участников
- `/reset_user_registration <user_id>` - Сброс регистрации конкретного пользователя
- `/sync_debate_cache` - Синхронизация кеша с базой данных

## Уведомления

Система автоматически уведомляет администраторов о:
- Новых регистрациях на дебаты (с именем пользователя и выбранным кейсом)
- Критических ошибках системы
- Проблемах с базой данных или Redis

## Миграции базы данных

Система использует Alembic для управления миграциями:

```bash
# Создание новой миграции
alembic revision --autogenerate -m "Description"

# Применение миграций
alembic upgrade head

# Откат миграции
alembic downgrade -1
```

## Мониторинг

Все операции регистрации логируются с уровнем INFO. Ошибки регистрации отправляются администраторам через систему telegram-уведомлений.

## Защита от race conditions

1. **Двойная проверка**: проверка доступности мест выполняется дважды - при выборе кейса и при подтверждении
2. **Атомарные операции**: использование транзакций БД и атомарных операций Redis
3. **Проверка существующей регистрации**: пользователь не может зарегистрироваться на второй кейс

## Структура файлов

```
app/infrastructure/database/
├── __init__.py          # Экспорты модуля
├── models.py            # SQLAlchemy модели
├── database.py          # Менеджер базы данных
└── redis_manager.py     # Менеджер Redis кеша

app/bot/dialogs/registration/
├── __init__.py          # Экспорт диалога
├── states.py            # Состояния FSM
├── handlers.py          # Обработчики событий
├── getters.py           # Функции получения данных
└── dialog.py            # Описание диалога

tools/
└── debate_manager.py    # Утилита управления системой

alembic/                 # Миграции базы данных
└── versions/
```

## Настройка окружения

Переменные окружения в `.env`:

```env
# PostgreSQL
POSTGRES_HOST=host
POSTGRES_PORT=5432
POSTGRES_USER=user
POSTGRES_PASSWORD=password
POSTGRES_DB=database

# Redis
REDIS_HOST=host
REDIS_PORT=6379
REDIS_PASSWORD=password
```